# Deploying a Hyperledger Fabric network on multiple host and installing a BNA on it using Hyperledger Composer

This tutorial was adapted from *"Setting up a Blockchain Business Network With Hyperledger Fabric & Composer Running in Multiple Physical Machine"* written by *Varun Raj*

https://medium.com/hyperlegendary/setting-up-a-blockchain-business-network-with-hyperledger-fabric-composer-running-in-multiple-bfbe4e38b6c6

---

**Note: This tutorial is for version 1.2 of Hyperledger Fabric and Composer 0.20.**

## Introduction

In this tutorial we're going to deploy a Hyperledger Fabric network on 2 virtual machines (VM) or hosts.

VM(1) consists of the following components:
- peer0.org1.example.com
- orderer.example.com
- couchdb
- ca.org1.example.com

VM(2) consists of the following components:
- peer1.org1.example.com
- couchdb1

## Prerequisites

The machines which are part of the Hyperledger Fabric network must be installed with the following software:
1. cURL
2. Docker
3. Docker Compose
4. Go Programming Language
5. Node.js
6. NPM
7. Hyperledger Fabric tools
8. Hyperledger Fabric Docker images
9. Hyperledger Composer tools

For installation instruction of list item 1 to 6, please see [Fabric-doc/prereqs](https://hyperledger-fabric.readthedocs.io/en/release-1.2/prereqs.html). Installation of the required tools can also be done following the instruction on [Composer-doc/prereqs](https://hyperledger.github.io/composer/latest/installing/installing-prereqs.html).

For installation instruction of list item 7 and 8, please see [Fabric-doc/install](https://hyperledger-fabric.readthedocs.io/en/release-1.2/install.html).

The [doc/install](https://hyperledger-fabric.readthedocs.io/en/release-1.2/install.html) link will gives the instruction on how to install the tools required for setting the network. These tools includes cryptogen, configtx, etc. After the installation you'll have a folder called ```/fabric-samples```, inside this folder go to ```/bin``` and add this bin path to the environment variable $PATH of your system. This process might differ base on your operation system, please look for instruction on how to "add to PATH" for your specific systems on the internet.

For installation instruction of list time 9, please see [Composer-dock/development-tools](https://hyperledger.github.io/composer/latest/installing/installing-prereqs.html). The instruction shows how to install the Composer tools required for installing the BNA on the Fabric network, and it also download the ```/fabric-dev-servers``` folder which contains the config files and scripts that going to work on.

## Cryptographic Keys and Channel Artifacts Configuration

Before proceeding with setting up for multiple machines deployment, the ```FABRIC_VERSION``` envrionment variable need to be set to ```hlfv12``` so that when starting the Fabric network, it knows what version to use. Since Fabric 1.2 is use in this tutorial, set the ```FABRIC_VERSION``` to be ```hlfv12```.

The files and scripts that are going to be work on are in ```/fabric-dev-servers/fabric-scripts/hlfv12/composer```.

**Note: Only VM(1) will be work on in the following steps.**

### crypto-config.yaml

This file is use as an input to crpytogen, a Hyperledger Fabric tool for generating cryptographic information. By default this file only specify 1 peer in the network, and since our network has 2 peers, we're going to change it to 2.

```
...
PeerOrgs:
    - Name: Org1
    Domain: org1.example.com
    Template:
        Count: 2
...
```

Under ```PeerOrgs```, ```Template``` change the ```Count``` value to ```2```.

Your ```crypto-config.yaml``` file should look like the following below:
```
OrdererOrgs:
  - Name: Orderer
    Domain: example.com
    Specs:
      - Hostname: orderer
PeerOrgs:
  - Name: Org1
    Domain: org1.example.com
    Template:
      Count: 2
    Users:
      Count: 0
```

**Note: Yaml files doesn't recognise tabs, so use spaces instead of tabs for indentations.**

### configtx.yaml

This file is use to dictate the content of the channel artifacts generated by configtxgen, a Hyperledger Fabric tool. The configuration for our network is already correct as it is in the file, so there's nothing more to add.

### Generate files

Once we've made changes to the above files (no changes were made to configtx.yaml for this tutorial), we'll need to run the following commands below:

This command will generate cryptographic information required for the Hyperledger Fabric network. It takes ```crypto-config.yaml``` as a config file. After generating the files, it will put the files in the ```crypto-config``` folder in the current directory.
```
cryptogen generate --config=./crypto-config.yaml
```

This command will set an environment variable that tells configtxgen where the config files are.
```
export FABRIC_CFG_PATH=$PWD
```

This command will create a genesis block.
```
configtxgen -profile ComposerOrdererGenesis -outputBlock ./composer-genesis.block
```

This command will create a channel creation transaction.
```
configtxgen -profile ComposerChannel -outputCreateChannelTx ./composer-channel.tx -channelID composerchannel
```

Copy ```crypto-config.yaml```, ```configtx.yaml``` and all the generated files and folder (```crypto-config```, ```composer-genesis.block```, ```composer-channel.tx```) from VM(1) to VM(2), and in VM(2) replace the existing files with it.

## Docker container configuration

We'll need to configure 2 ```docker-compose.yml``` files. One in VM(1) and one in VM(2).

### For ```docker-compose.yml``` in VM(1) do the following:

1. Under ```services```, ```ca.org1.example.com```, ```command```, there's a tag for ```ca.keyfile```. Change the name of the keyfile to match the name of the generated keyfile in your VM. The file is located in ```/crypto-config/peerOrganizations/org1.example.com/ca```. The file will look like a long string of numbers followed by ```_sk```. An example of the ```command``` value is displayed below.

    ```
    command: sh -c 'fabric-ca-server start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/7434883cff30872c67f9c92c8aa622d60f833e2c16797098a46620813945c101_sk -b admin:adminpw -d'
    ```
    See how the keyfile is called ```7434883cff30872c67f9c92c8aa622d60f833e2c16797098a46620813945c101_sk```.

    Your docker-compose.yml file should look like the following below:

    ```
    version: '2'

    services:
    ca.org1.example.com:
        image: hyperledger/fabric-ca:1.2.0
        environment:
        - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
        - FABRIC_CA_SERVER_CA_NAME=ca.org1.example.com

        ports:
        - "7054:7054"
        command: sh -c 'fabric-ca-server start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/7434883cff30872c67f9c92c8aa622d60f833e2c16797098a46620813945c101_sk -b admin:adminpw -d'
        volumes:
        - ./crypto-config/peerOrganizations/org1.example.com/ca/:/etc/hyperledger/fabric-ca-server-config
        container_name: ca.org1.example.com

    orderer.example.com:
        container_name: orderer.example.com
        image: hyperledger/fabric-orderer:1.2.0
        environment:
        - ORDERER_GENERAL_LOGLEVEL=debug
        - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
        - ORDERER_GENERAL_GENESISMETHOD=file
        - ORDERER_GENERAL_GENESISFILE=/etc/hyperledger/configtx/composer-genesis.block
        - ORDERER_GENERAL_LOCALMSPID=OrdererMSP
        - ORDERER_GENERAL_LOCALMSPDIR=/etc/hyperledger/msp/orderer/msp
        working_dir: /opt/gopath/src/github.com/hyperledger/fabric
        command: orderer
        ports:
        - 7050:7050
        volumes:
            - ./:/etc/hyperledger/configtx
            - ./crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp:/etc/hyperledger/msp/orderer/msp

    peer0.org1.example.com:
        container_name: peer0.org1.example.com
        image: hyperledger/fabric-peer:1.2.0
        environment:
        - CORE_LOGGING_LEVEL=debug
        - CORE_CHAINCODE_LOGGING_LEVEL=DEBUG
        - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
        - CORE_PEER_ID=peer0.org1.example.com
        - CORE_PEER_ADDRESS=peer0.org1.example.com:7051
        - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=composer_default
        - CORE_PEER_LOCALMSPID=Org1MSP
        - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/peer/msp
        - CORE_LEDGER_STATE_STATEDATABASE=CouchDB
        - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb:5984
        working_dir: /opt/gopath/src/github.com/hyperledger/fabric
        command: peer node start
        ports:
        - 7051:7051
        - 7053:7053
        volumes:
            - /var/run/:/host/var/run/
            - ./:/etc/hyperledger/configtx
            - ./crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp:/etc/hyperledger/peer/msp
            - ./crypto-config/peerOrganizations/org1.example.com/users:/etc/hyperledger/msp/users
        depends_on:
        - orderer.example.com
        - couchdb

    couchdb:
        container_name: couchdb
        image: hyperledger/fabric-couchdb:0.4.10
        ports:
        - 5984:5984
        environment:
        DB_URL: http://localhost:5984/member_db

    ```    

### For ```docker-compose.yml``` in VM(2) do the following:

1. Same as step 1 for VM(1), we're going to reference the ca keyfile from the ```/crypto-config``` folder in ```command```. The keyfile should be the same as in VM(1) because we've copied it over from VM(1).
2. Since on VM(2) we only have a peer and a couchdb, we're going to delete the ```ca.org1.example.com``` and ```orderer.example.com``` section.
3. In VM(1) the peer is called ```peer0.org1.example.com```, in VM(2) the peer will be called ```peer1.org1.example.com```. In the file we have to change all reference of ```peer0...``` to ```peer1...```.
4. Change the docker host port of peer1 to 8051 and 8053. This is the docker port mapping function, where we want the docker container's 7051 port to map to the host's 8051 port. This can be done under ```peer1...```, ```ports```.
    ```
    ports:
        - 8051:7051
        - 8053:7053
    ```
5. Set ```extra_hosts``` for peer1. This need to be set so that inside the docker container of peer1, it knows the IP address of the orderer from VM(1). Set the extra_hosts for orderer.example.com and orderer.org1.example.com. Replace ```123.456.789.10``` with the IP address of VM(1).
    ```
    extra_hosts:
        - "orderer.example.com:123.456.789.10"
        - "orderer.org1.example.com:123.456.789.10"
    ```
6. We're going to change the name of the couchdb in VM(2) to couchdb1. Change all references of ```couchdb``` to ```couchdb1```.
7. Similar to step 4, we're going to change the docker host port of couchdb to 6984.
    ```
    ports:
        - 6984:5984
    ```

    Your docker-compose.yml file should look like the following below:
    ```
    version: '2'
    
    services:
    peer1.org1.example.com:
        container_name: peer1.org1.example.com
        image: hyperledger/fabric-peer:1.2.0
        environment:
        - CORE_LOGGING_LEVEL=debug
        - CORE_CHAINCODE_LOGGING_LEVEL=DEBUG
        - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
        - CORE_PEER_ID=peer1.org1.example.com
        - CORE_PEER_ADDRESS=peer1.org1.example.com:7051
        - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=composer_default
        - CORE_PEER_LOCALMSPID=Org1MSP
        - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/peer/msp
        - CORE_LEDGER_STATE_STATEDATABASE=CouchDB
        - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb1:5984
        working_dir: /opt/gopath/src/github.com/hyperledger/fabric
        command: peer node start
        ports:
        - 8051:7051
        - 8053:7053
        extra_hosts:
        - "orderer.example.com:123.456.789.10"
        - "orderer.org1.example.com:123.456.789.10"
        volumes:
            - /var/run/:/host/var/run/
            - ./:/etc/hyperledger/configtx
            - ./crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/msp:/etc/hyperledger/peer/msp
            - ./crypto-config/peerOrganizations/org1.example.com/users:/etc/hyperledger/msp/users
        depends_on:
        - couchdb1

    couchdb1:
        container_name: couchdb1
        image: hyperledger/fabric-couchdb:0.4.10
        ports:
        - 6984:5984
        environment:
        DB_URL: http://localhost:6984/member_db

    ```

## Shell Scripts

We're all done configurating files in ```/fabric-dev-servers/fabric-scripts/hlfv12/composer```.
Now we're going to configure shell scripts for creating a PeerAdmin card, and starting the Hyperledger Fabric network.

Move back out of the ```/composer``` folder and into ```/fabric-dev-servers/fabric-scripts/hlfv12```. This is where we'll be working from now on.

### VM(1)'s ```createPeerAdminCard.sh```
On VM(1) we're going to configure the connection profile of the network and the ```PRIVATE_KEY``` constant of the admin user.

Under DevServer_connection.json section do the following:
1. Under ```channels```, ```composerchannel```, ```peers``` add another peer called ```peer1.org1.example.com```. This represents the peer set in VM(2).
2. Under both peer0 and peer1 from step 1, add and set the 4 values as true:
    - ```"endorsingPeer": true```
    - ```"chaincodeQuery": true```
    - ```"ledgerQuery": true```
    - ```"eventSource": true```

    ```
    ...
    "composerchannel": {
            "orderers": [
                "orderer.example.com"
            ],
            "peers": {
                "peer0.org1.example.com": {
                    "endorsingPeer": true,
                    "chaincodeQuery": true,
                    "ledgerQuery": true,
                    "eventSource": true
                },
                "peer1.org1.example.com": {
                    "endorsingPeer": true,
                    "chaincodeQuery": true,
                    "ledgerQuery": true,
                    "eventSource": true
                }
            }
        }
    ...
    ```
3. Under ```Organizations```, ```Org1```, ```peers``` add in ```peer1.org1.example.com```.
    ```
    ...
    "organizations": {
        "Org1": {
            "mspid": "Org1MSP",
            "peers": [
                "peer0.org1.example.com",
                "peer1.org1.example.com"
            ],
        ...
    ...
    ```
4. Under ```peers``` add in ```peer1.org1.example.com``` with the following values, replace ```010.987.654.321``` with the IP adress of VM(2) :
    - ```"url": "grpc://010.987.654.321:8051"```
    - ```"eventUrl": "grpc://010.987.654.321:8053"```
    ```
    ...
    "peers": {
        "peer0.org1.example.com": {
            "url": "grpc://${HOST}:7051",
            "eventUrl": "grpc://${HOST}:7053"
        },
        "peer1.org1.example.com": {
            "url": "grpc://010.987.654.321:8051",
            "eventUrl": "grpc://010.987.654.321:8053"
        }
    },
    ...
    ```
5. In the ```PRIVATE_KEY``` constant, change the name of the keyfile to match the keyfile you've generated in ```/composer/crypto-config/...``` folder. It should look like this:
    ```
    PRIVATE_KEY="${DIR}"/composer/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/keystore/4e3ab3333976a182f50b14d10bd2eaf5102b636c19c09ecc8260880b0029c1fe_sk
    ```

Your connection profile should look like the following below:
```
...
cat << EOF > DevServer_connection.json
{
    "name": "hlfv1",
    "x-type": "hlfv1",
    "x-commitTimeout": 300,
    "version": "1.0.0",
    "client": {
        "organization": "Org1",
        "connection": {
            "timeout": {
                "peer": {
                    "endorser": "300",
                    "eventHub": "300",
                    "eventReg": "300"
                },
                "orderer": "300"
            }
        }
    },
    "channels": {
        "composerchannel": {
            "orderers": [
                "orderer.example.com"
            ],
            "peers": {
                "peer0.org1.example.com": {
                    "endorsingPeer": true,
                    "chaincodeQuery": true,
                    "ledgerQuery": true,
                    "eventSource": true
                },
                "peer1.org1.example.com": {
                    "endorsingPeer": true,
                    "chaincodeQuery": true,
                    "ledgerQuery": true,
                    "eventSource": true
                }
            }
        }
    },
    "organizations": {
        "Org1": {
            "mspid": "Org1MSP",
            "peers": [
                "peer0.org1.example.com",
                "peer1.org1.example.com"
            ],
            "certificateAuthorities": [
                "ca.org1.example.com"
            ]
        }
    },
    "orderers": {
        "orderer.example.com": {
            "url": "grpc://${HOST}:7050"
        }
    },
    "peers": {
        "peer0.org1.example.com": {
            "url": "grpc://${HOST}:7051",
            "eventUrl": "grpc://${HOST}:7053"
        },
        "peer1.org1.example.com": {
            "url": "grpc://010.987.654.321:8051",
            "eventUrl": "grpc://010.987.654.321:8053"
        }
    },
    "certificateAuthorities": {
        "ca.org1.example.com": {
            "url": "http://${HOST}:7054",
            "caName": "ca.org1.example.com"
        }
    }
}
EOF
...
```

### VM(2)'s startFabric.sh

1. Delete the two ```docker exec``` commands:
    - ```docker exec peer0.org1.example.com peer channel create -o orderer.example.com:7050 ...```
    - ```docker exec -e "CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp/users/Admin@org1.example.com/msp" ...```

2. Add in two new ```docker exec``` commands. These commands will be used to join ```peer1.org1.example.com``` to the network channel ```composerchannel```.
    ```
    docker exec -e "CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp/users/Admin@org1.example.com/msp" peer1.org1.example.com peer channel fetch config -o orderer.org1.example.com:7050 -c composerchannel

    docker exec -e "CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp/users/Admin@org1.example.com/msp" peer1.org1.example.com peer channel join -b composerchannel_config.block
    ```
## Starting the network

### VM(1) commands

On VM(1) run the following command inside the ```/fabric-dev-servers```:
```
$ ./startFabric.sh
$ ./createPeerAdminCard.sh
```
The first command will start the Hyperledger Fabric network. This script will start 4 docker container services, one each for a peer, ca, orderer, and couchdb.

The second command will create a PeerAdmin card which is used for installing the Business Network onto the Hyperledger Fabric network.

### VM(2) commands

On VM(2) run the following command inside the ```/fabric-dev-servers```:
```
$ ./startFabric.sh
```
This command will join peer1 on VM(2) to the network channel. It essentially joins the peer to the network started from VM(1).

## Deploying the Business Network onto the Hyperledger Fabric network

1. Run the following command below to install the business network to the Hyperledger Fabric network:
    ```
    composer network install -c PeerAdmin@hlfv1 -a business-network@0.0.1.bna
    ```
2. Run the following command below to start the business network on the Hyperledger Fabric network:
    ```
    composer network start -n business-network -V 0.0.1 -A admin -S adminpw -c PeerAdmin@hlfv1 -f networkadmin.card
    ```

---

This tutorial was adapted from *"Setting up a Blockchain Business Network With Hyperledger Fabric & Composer Running in Multiple Physical Machine"* written by *Varun Raj*

https://medium.com/hyperlegendary/setting-up-a-blockchain-business-network-with-hyperledger-fabric-composer-running-in-multiple-bfbe4e38b6c6
